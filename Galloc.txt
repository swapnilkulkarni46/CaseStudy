Sub Allocation()

Dim rngVisible As Range
Dim iCount As Integer
Dim strNumber As String
Dim iArr As Variant
Dim i As Integer
Dim perCentAmount As Integer
Dim per As Double
Dim PerToDo As Integer
Dim r As Range
Dim rAgent As Range


Sheets("Temp").Visible = True

Sheet3.AutoFilterMode = False

With Sheet3
    .Sort.SortFields.Clear
    .Sort.SortFields.Add Key:=Range( _
        "B2:B" & Lastrowsh3), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    .Sort.SortFields.Add Key:=Range( _
        "AH2:AH" & Lastrowsh3), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    .Sort.SortFields.Add Key:=Range( _
        "K2:K" & Lastrowsh3), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    .Sort.SortFields.Add Key:=Range( _
        "G2:G" & Lastrowsh3), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:= _
        xlSortNormal
    .Sort.SetRange Range("A1:AH" & Lastrowsh3)
    .Sort.Header = xlYes
    .Sort.MatchCase = False
    .Sort.Orientation = xlTopToBottom
    .Sort.SortMethod = xlPinYin
    .Sort.Apply
End With

'Get All Processors Name in Temp Sheet
Set gl_shTemp = ThisWorkbook.Worksheets("Temp")
gl_shTemp.Range("A:AZ").Clear
Sheet3.Range(Sheet3.Range("B1").Offset(1, 0), "B" & Range("A100000").End(xlUp).Row).SpecialCells(xlCellTypeVisible).Copy gl_shTemp.Range("B1")
gl_shTemp.Range("B1:B" & gl_shTemp.Range("B100000").End(xlUp).Row).AdvancedFilter Action:=xlFilterCopy, CopyToRange:=gl_shTemp.Range("A1"), Unique:=True
If Trim(gl_shTemp.Range("A1").Value) = Trim(gl_shTemp.Range("A2").Value) Then
    gl_shTemp.Range("A1").Delete Shift:=xlShiftUp
End If
gl_shTemp.Range("B:B").Clear

'Loop for All Processor Names
For Each r In gl_shTemp.Range("A1:A" & gl_shTemp.Range("A100000").End(xlUp).Row)
    Sheet3.AutoFilterMode = False
    Sheet3.Range("A1:AH" & Lastrowsh3).AutoFilter Field:=2, Criteria1:=r.Text            'Filter with Current Processor Name
    Sheet3.Range("A1:AH" & Lastrowsh3).AutoFilter Field:=34, Criteria1:="Negative"
    If Sheet3.Range("A100000").End(xlUp).Row <> 1 Then
        Sheet3.Range("A1:AH" & Lastrowsh3).AutoFilter Field:=11, Criteria1:="AUD"
        
        If Sheet3.Range("A100000").End(xlUp).Row <> 1 Then
            Sheet3.Range("A1:AH" & Lastrowsh3).AutoFilter Field:=7, Criteria1:="Normal"
                
            If Sheet3.Range("A100000").End(xlUp).Row <> 1 Then
                Set rAgent = Sheet2.Range("B1", Sheet2.Range("B1").End(xlDown)).Find(What:=r.Value, LookAt:=xlWhole)
                On Error GoTo Nxt
                PerToDo = rAgent.Offset(0, 1)
                On Error GoTo 0
                per = (PerToDo / 100)
                Set rngVisible = Sheet3.Range("A2:A" & Cells(Rows.Count, "A").End(xlUp).Row).SpecialCells(xlCellTypeVisible)
                iCount = rngVisible.Count
                perCentAmount = WorksheetFunction.Round(iCount * per, 1)    'Guri
                If perCentAmount = 0 Then GoTo Nxt                          'Guri
                strNumber = Trim(Percent_Logic(rngVisible(1).Row, rngVisible(iCount).Row, perCentAmount))
                iArr = Split(strNumber)
                For i = 0 To perCentAmount - 1
                    Sheet3.Range("AG" & iArr(i)).Value = "Perform QC"
                Next i
            End If
            
        End If
        
    End If
Nxt:
Next r

Sheet3.AutoFilterMode = False
Sheet3.Columns("AH").Delete
Sheets("Temp").Visible = False



End Sub