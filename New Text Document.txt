Function RefreshListView()
Dim SQL As String
Dim Pflag As String

If optCompleted.Value = True Then Pflag = "D"
If optPending.Value = True Then Pflag = "R"
If optQueried.Value = True Then Pflag = "Q"
'If optCF.Value = True Then Pflag = "C"

lblCounts.Caption = "Refreshing Records..."
lblCounts.ForeColor = vbBlue
Me.Refresh
Application.Wait (Now + TimeValue("0:00:01"))
lblCounts.Caption = "Please wait..."
lblCounts.ForeColor = vbBlue
Me.Refresh
Application.Wait (Now + TimeValue("0:00:01"))




SQL = ""
'sql = sql & " select * from (SELECT Ent.ID, Ent.TRNature ,Ent.Employee_number, Ent.Employee_Name, Ent.Leave_date, Ent.Payment_type, Ent.Hours_days, Ent.Payment_Amount, Ent.Deduction_type, Ent.Deduction_Amount, Ent.Effective_date, Ent.New_amount, Ent.New_hours, Ent.Existing_dept, Ent.New_Dept, Ent.Comments,Ent.PayComments,Ent.DedComments, Ent.AddedBy, Ent.TimeStamp,"
'sql = sql & "  Ent.AbsenceType , Ent.AbsenceFrom, Ent.AbsenceTo , Ent.AbsenceComments , Last(Act.WNSStatus) AS LastStatus, Last(Act.WNSComments) AS LastComments, Last(Act.WNSActionBy) AS LastActionBy, Last(Act.WNSTimeStamp) AS LastActionon"
'sql = sql & " FROM tblNotificationEntries Ent LEFT JOIN tblWNSActionHistory Act ON Ent.ID = Act.ParentID"
'sql = sql & " GROUP BY Ent.ID, Ent.TRNature , Ent.Employee_number, Ent.Employee_Name, Ent.Leave_date, Ent.Payment_type, Ent.Hours_days, Ent.Payment_Amount, Ent.Deduction_type, Ent.Deduction_Amount, Ent.Effective_date, Ent.New_amount, Ent.New_hours, Ent.Existing_dept, Ent.New_Dept, Ent.Comments, Ent.PayComments,Ent.DedComments,Ent.AddedBy, Ent.TimeStamp , Ent.AbsenceType , Ent.AbsenceFrom, Ent.AbsenceTo , Ent.AbsenceComments"
'sql = sql & " order BY Ent.ID desc)"

SQL = New_SelectQry


If Pflag = "Q" Then
    SQL = SQL & " where LastStatus  = 'Queried'"
ElseIf Pflag = "D" Then
    SQL = SQL & " where LastStatus  = 'Done'"
ElseIf Pflag = "R" Then
    SQL = SQL & " where LastStatus is null or LastStatus = 'Resolved'"
ElseIf Pflag = "C" Then
    SQL = SQL & " where LastStatus = 'Carry Forward'"
End If

SQL = SQL & " and TimeStamp >= #" & Format(PeriodStart, "DD-MMM-YY") & "# and TimeStamp <= #" & Format(PeriodEnd + 1, "DD-MMM-YY") & "#"
SQL = SQL & " ORDER BY Ent.ID desc "



lblCounts.Caption = f.ShowLviewList(Me, lviewAllItems, SQL, DatabasePath, DatabaseName) & " Record(s) found...."
lblCounts.ForeColor = &HC000C0

End Function


Public Function ShowLviewList(ByRef frm As Form, ByVal lview As ListView, SQL As String, DBPath As String, Db As String, Optional bCallLog As Boolean) As Long
Dim ltag        As Integer
Dim varVals     As Variant
Dim J           As Long
Dim cnt         As Integer
Dim columnY     As ColumnHeader
Dim newItm      As ListItem
Dim cn          As New ADODB.Connection
Dim rs          As New ADODB.Recordset
Dim WNSUserActioned As Boolean

cnt = 0


On Error GoTo NormalExit:


lview.ListItems.Clear
lview.ColumnHeaders.Clear

If cn.State = 0 Then Conn cn, Db, DBPath

rs.Open SQL, cn, adOpenForwardOnly, adLockReadOnly


If Not (rs.EOF Or rs.BOF) Then
    For J = 0 To rs.Fields.Count - 1
        Set columnY = lview.ColumnHeaders.Add(J + 1, "Dip" & J, rs.Fields(J).Name)
        
      
        
        
'
'            If Lview.Name = "ListView8" Then
'                cmbFcrite.AddItem rs.Fields(j).Name
'                Select Case rs.Fields(j).Type
'                Case 7
'                    cmbFcrite.List(j, 1) = " = #@#"
'                Case 202
'                    cmbFcrite.List(j, 1) = " Like '%@%'"
'                Case 3, 5
'                    cmbFcrite.List(j, 1) = " Like '@%'"
'                End Select
'            End If
    Next
'    rs.MoveFirst
    ltag = 1
    While Not rs.EOF
    
    Set newItm = lview.ListItems.Add(lview.ListItems.Count + 1, "vik" & lview.ListItems.Count + 1, IIf(Len(rs.Fields(0).Value) > 0, rs.Fields(0).Value, ""))
     

    
        If bCallLog = True Then
        
            If rs.Fields("Status") = "Open" And rs.Fields("HRQuery") = "Yes" Then
                newItm.ForeColor = vbRed
            ElseIf rs.Fields("Status") = "Close" Then
                newItm.ForeColor = vbBlue
            ElseIf rs.Fields("Status") = "Open" Then
                newItm.ForeColor = &H80FF&

            End If
        
        Else
        If IsNull(rs.Fields("LastActionBy")) = True Then
            If InStr(1, rs.Fields(1), "Input", vbTextCompare) > 0 Then
                newItm.ForeColor = vbBlue
            ElseIf InStr(1, rs.Fields(1), "Query", vbTextCompare) > 0 Then
                newItm.ForeColor = vbRed
            End If
        Else
             WNSUserActioned = checkuserName(rs.Fields("LastActionBy"))
            If rs.Fields("LastStatus") = "Queried" Then
                newItm.ForeColor = vbMagenta
            ElseIf InStr(1, rs.Fields(1), "Input", vbTextCompare) > 0 Then
                        newItm.ForeColor = vbBlue
            ElseIf InStr(1, rs.Fields(1), "Query", vbTextCompare) > 0 Then
                        newItm.ForeColor = vbRed
            End If
        End If
        End If

'
                    
        For J = 1 To rs.Fields.Count - 1
            If Len(rs.Fields(J).Value) > 0 Then
'                If rs.Fields(j).Value > 0 Then
                    If rs.Fields(J).Type = 5 Then
                        newItm.SubItems(J) = Format(rs.Fields(J).Value, "#,##0.00")
                    ElseIf rs.Fields(J).Type = 7 Then
                        newItm.SubItems(J) = Format(rs.Fields(J).Value, "dd-MMM-yyyy")
                    Else
                        newItm.SubItems(J) = rs.Fields(J).Value
                    End If
                    
                    If bCallLog = True Then
                        If rs.Fields("Status") = "Open" And rs.Fields("HRQuery") = "Yes" Then
                            newItm.ListSubItems(J).ForeColor = vbRed
                        ElseIf rs.Fields("Status") = "Close" Then
                           newItm.ListSubItems(J).ForeColor = vbBlue
                        ElseIf rs.Fields("Status") = "Open" Then
                            newItm.ListSubItems(J).ForeColor = &H80FF&
    
                        End If
                    Else
                    
                   If IsNull(rs.Fields("LastActionBy")) = True Then
                        If InStr(1, rs.Fields(1), "Input", vbTextCompare) > 0 Then
                            newItm.ListSubItems(J).ForeColor = vbBlue
                        ElseIf InStr(1, rs.Fields(1), "Query", vbTextCompare) > 0 Then
                            newItm.ListSubItems(J).ForeColor = vbRed
                        End If
                    Else
                         WNSUserActioned = checkuserName(rs.Fields("LastActionBy"))

                        'If WNSUserActioned = True And rs.Fields("LastStatus") = "Queried" Then
                        If rs.Fields("LastStatus") = "Queried" Then
                            newItm.ListSubItems(J).ForeColor = vbMagenta
                        ElseIf InStr(1, rs.Fields(1), "Input", vbTextCompare) > 0 Then
                                    newItm.ListSubItems(J).ForeColor = vbBlue
                        ElseIf InStr(1, rs.Fields(1), "Query", vbTextCompare) > 0 Then
                                    newItm.ListSubItems(J).ForeColor = vbRed
                        End If
                    End If
                    End If
                    
'                End If
            End If
        Next
    
    rs.MoveNext
    ltag = ltag + 1
    If ltag > 7 Then ltag = 1
    Wend
End If
NormalExit:
If rs.State = 1 Then rs.Close
If cn.State = 1 Then cn.Close

LviewColumnAutosize lview

ShowLviewList = lview.ListItems.Count



'If lviewfollowup.Visible = True Then lviewfollowup.Visible = False
End Function